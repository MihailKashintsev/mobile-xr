name: Build & Deploy

on:
  push:
    branches: [main]
    tags: ['v*.*.*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Ğ’ĞµÑ€ÑĞ¸Ñ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾, Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 1.2.3)'
        required: false

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: npm }

      - run: npm ci

      - name: Determine version
        id: ver
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            # Ğ¢ĞµĞ³ â†’ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ĞµĞ³Ğ¾
            VERSION="${GITHUB_REF_NAME#v}"
          elif [[ -n "${{ inputs.version }}" ]]; then
            # Manual dispatch
            VERSION="${{ inputs.version }}"
            VERSION="${VERSION#v}"
          else
            # ĞĞ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ push â†’ Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ + Ğ½Ğ¾Ğ¼ĞµÑ€ ÑĞ±Ğ¾Ñ€ĞºĞ¸ + Ñ…ÑÑˆ
            BASE=$(node -e "process.stdout.write(require('./package.json').version)")
            BUILD=$(git rev-list --count HEAD)
            SHORT=$(git rev-parse --short HEAD)
            VERSION="${BASE}+${BUILD}.${SHORT}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ VERSION: ${VERSION}"

      - name: Build
        run: npm run build
        env:
          APP_VERSION: ${{ steps.ver.outputs.version }}

      - uses: actions/upload-pages-artifact@v3
        with: { path: dist }

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/configure-pages@v4
      - id: deployment
        uses: actions/deploy-pages@v4
